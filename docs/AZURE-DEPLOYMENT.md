# Azure Static Web Apps Deployment Guide

## Overview

This guide covers deploying the Knowledge Harvest MVP to **Azure Static Web Apps** using the GitHub Actions workflow.

---

## Prerequisites

- Azure account with Static Web Apps enabled
- GitHub repository
- Azure OpenAI service set up

---

## Important: Next.js on Azure Static Web Apps

⚠️ **Note**: Azure Static Web Apps has **limited support** for Next.js server-side features. The current setup works best for:
- Static pages
- Client-side rendering
- API routes (with limitations)

For **full Next.js support** including:
- Server-side rendering (SSR)
- Incremental Static Regeneration (ISR)
- WebRTC Realtime API integration

**We recommend using Vercel or Azure Container Apps instead** (see alternatives below).

---

## Setup Steps

### 1. Create Azure Static Web App

```bash
# Using Azure CLI
az staticwebapp create \
  --name knowledge-harvest \
  --resource-group your-resource-group \
  --source https://github.com/your-username/dimes-knowledge-harvest \
  --location "East US 2" \
  --branch main \
  --app-location "/" \
  --output-location ".next"
```

Or via Azure Portal:
1. Go to Azure Portal → Create Resource
2. Search "Static Web Apps"
3. Fill in:
   - **Name**: knowledge-harvest
   - **Region**: East US 2 (or nearest)
   - **Deployment source**: GitHub
   - **Repository**: Your repo
   - **Branch**: main
   - **Build preset**: Next.js
   - **App location**: /
   - **Output location**: .next

### 2. Configure GitHub Secrets

The workflow requires these secrets in your GitHub repository:

Go to: **Settings → Secrets and variables → Actions → New repository secret**

Add the following:

#### Required Secrets

```
AZURE_STATIC_WEB_APPS_API_TOKEN_VICTORIOUS_BUSH_0A51DA000
  → (Auto-generated by Azure, already in your workflow)

AZURE_OPENAI_API_KEY
  → Your Azure OpenAI API key

AZURE_OPENAI_ENDPOINT
  → https://your-resource.openai.azure.com/

AZURE_OPENAI_DEPLOYMENT_NAME
  → gpt-4 (or your deployment name)

AZURE_OPENAI_API_VERSION
  → 2024-08-01-preview
```

#### Optional Secrets (for full features)

```
AZURE_OPENAI_REALTIME_DEPLOYMENT_NAME
  → gpt-4o-realtime-preview

AZURE_SPEECH_KEY
  → Your Speech Service key

AZURE_SPEECH_REGION
  → japaneast (or your region)

AZURE_STORAGE_CONNECTION_STRING
  → For audio file storage

AZURE_SEARCH_API_KEY
  → For AI Search integration
```

### 3. Update Workflow (Already Done)

The `.github/workflows/azure-static-web-apps-*.yml` file has been updated to:
- ✅ Use Node.js 20
- ✅ Rebuild `better-sqlite3`
- ✅ Build Next.js app with environment variables
- ✅ Deploy `.next` output directory

### 4. Push and Deploy

```bash
git add .
git commit -m "Configure Azure Static Web Apps deployment"
git push origin main
```

The GitHub Action will automatically:
1. Install dependencies
2. Rebuild native modules
3. Build the Next.js app
4. Deploy to Azure

---

## Post-Deployment Configuration

### Configure Environment Variables in Azure

After deployment, also add environment variables directly in Azure:

1. Go to Azure Portal → Your Static Web App
2. **Settings → Configuration**
3. Add application settings:

```
AZURE_OPENAI_API_KEY=your_key
AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com/
AZURE_OPENAI_DEPLOYMENT_NAME=gpt-4
AZURE_OPENAI_API_VERSION=2024-08-01-preview
DATABASE_URL=/tmp/knowledge-harvest.db
```

⚠️ **Important**: The SQLite database will be ephemeral on Azure Static Web Apps. For persistence, use:
- Azure SQL Database
- Azure Cosmos DB
- Or migrate to Vercel/Azure Container Apps

---

## Limitations of Azure Static Web Apps for Next.js

### What Works ✅
- Static pages (Home, Seed, Interview UI, Dashboard UI)
- Client-side data fetching
- API routes (basic)
- Mock data functionality

### What Has Limitations ⚠️
- **Database**: SQLite is ephemeral (resets on deployment)
- **Server-side rendering**: Limited support
- **WebRTC**: May need custom signaling server
- **File uploads**: Limited to 100MB
- **Cold starts**: API routes may have latency

### What Doesn't Work ❌
- Persistent SQLite database
- Advanced Next.js features (ISR, middleware)
- Long-running connections (WebSocket/WebRTC signaling)

---

## Recommended Alternatives

### Option 1: Vercel (Recommended for MVP)

**Pros:**
- ✅ Built for Next.js
- ✅ Automatic deployments
- ✅ Generous free tier
- ✅ Built-in database options

**Setup:**
```bash
npm install -g vercel
vercel login
vercel
# Follow prompts, add environment variables
```

See [DEPLOYMENT.md](./DEPLOYMENT.md) for detailed Vercel instructions.

---

### Option 2: Azure Container Apps (Recommended for Production)

**Pros:**
- ✅ Full Next.js support
- ✅ Persistent storage options
- ✅ Better scaling
- ✅ All Azure ecosystem

**Setup:**
```bash
# Create container registry
az acr create --name kharvest --resource-group rg --sku Basic

# Build and push Docker image
docker build -t kharvest:latest .
docker tag kharvest:latest kharvest.azurecr.io/kharvest:latest
docker push kharvest.azurecr.io/kharvest:latest

# Deploy to Container Apps
az containerapp create \
  --name knowledge-harvest \
  --resource-group rg \
  --image kharvest.azurecr.io/kharvest:latest \
  --environment my-env \
  --ingress external \
  --target-port 3000
```

Requires `Dockerfile`:
```dockerfile
FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci
RUN npm rebuild better-sqlite3

COPY . .
RUN npm run build

EXPOSE 3000

CMD ["npm", "start"]
```

---

### Option 3: Azure App Service

**Pros:**
- ✅ Easy deployment
- ✅ Built-in scaling
- ✅ Managed service

**Setup:**
```bash
az webapp up \
  --name knowledge-harvest \
  --resource-group rg \
  --runtime "NODE:20-lts" \
  --sku B1
```

---

## Monitoring & Debugging

### View Deployment Logs

**GitHub Actions:**
- Go to: **Actions** tab in GitHub
- Click on latest workflow run
- Check "Build and Deploy Job" logs

**Azure Portal:**
- Go to: Your Static Web App → **Deployment History**
- Or: **Application Insights** for runtime logs

### Test Deployment

After successful deployment:

```bash
# Get your Azure Static Web App URL
az staticwebapp show \
  --name knowledge-harvest \
  --resource-group rg \
  --query "defaultHostname" -o tsv

# Test API endpoints
curl https://your-app.azurestaticapps.net/api/coverage?mock=true

# Test homepage
curl https://your-app.azurestaticapps.net/
```

---

## Common Issues

### 1. Build Fails with "better-sqlite3" Error

**Solution:** The workflow now includes `npm rebuild better-sqlite3`

### 2. Environment Variables Not Available

**Solution:**
- Add secrets to GitHub (for build time)
- Add configuration to Azure Static Web App (for runtime)

### 3. Database Resets on Each Deployment

**Expected:** SQLite on Azure Static Web Apps is ephemeral.

**Solutions:**
- Use mock data mode for demos
- Migrate to Azure SQL Database
- Use Vercel Postgres
- Switch to Azure Container Apps

### 4. API Routes Return 500 Errors

**Debug:**
```bash
# Check Azure logs
az staticwebapp logs show \
  --name knowledge-harvest \
  --resource-group rg
```

**Common causes:**
- Missing environment variables
- Database connection errors
- Module version mismatches

---

## Cost Estimates

**Azure Static Web Apps:**
- Free tier: 100GB bandwidth, 0.5GB storage
- Standard tier: $9/month + usage

**For production, also consider:**
- Azure OpenAI: Pay-per-token (~$5-50/month)
- Azure SQL Database: ~$5-20/month (if used)
- Azure Storage: ~$1-5/month

**Total:** ~$10-85/month depending on usage

---

## Recommendation

For the **Knowledge Harvest MVP**, we recommend:

### For Demos: **Vercel**
- Easiest setup
- Best Next.js support
- Free for demos
- Quick deployments

### For Production: **Azure Container Apps**
- Full control
- All Azure services integrated
- Persistent storage
- Better scaling

### Current Setup (Azure Static Web Apps):
- ✅ Works for basic demo
- ⚠️ Limited features
- ❌ No persistent database

---

## Next Steps

1. **Test current deployment** on Azure Static Web Apps
2. **Use mock data mode** for demos
3. **Plan migration** to Vercel or Azure Container Apps if you need:
   - Persistent database
   - Full Next.js features
   - Production-grade reliability

---

## Support

- [Azure Static Web Apps Docs](https://learn.microsoft.com/en-us/azure/static-web-apps/)
- [Next.js on Azure](https://learn.microsoft.com/en-us/azure/static-web-apps/deploy-nextjs-hybrid)
- [DEPLOYMENT.md](./DEPLOYMENT.md) - Vercel deployment guide
- [TROUBLESHOOTING.md](./TROUBLESHOOTING.md) - Common issues
